#+TITLE:A POSITION ALLOCATION PROBLEM APPROACH TO THE BATTERY ELECTRIC BUS CHARGING PROBLEM
#+author: Alexander Brown
#+date: \today

#+startup: beamer
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [presentation]
#+BEAMER_THEME: default
#+BEAMER_COLOR_THEME: dolphin
#+OPTIONS: H:2
#+OPTIONS:   tex:t d:nil todo:t pri:nil tags:nil

# ##############################################################################
# Helpful URLs
# ##############################################################################

# https://orgmode.org/worg/exporters/beamer/tutorial.html
# https://github.com/dfeich/org-babel-examples/blob/master/beamer/beamer-example.org?plain=1

# ##############################################################################
# Packages
# ##############################################################################

#+latex_header: \usepackage{appendixnumberbeamer}
#+latex_header: \usepackage{amssymb}
#+latex_header: \usepackage{tabularx}
#+latex_header: \usepackage[group-separator={,}, group-minimum-digits=3]{siunitx}   % Format numbers
#+latex_header: \usepackage[ruled]{algorithm2e}             % Algorithms
#+latex_header: \usepackage{tikz}                           % Draw stuff
#+latex_header: \usetikzlibrary{arrows.meta}                % Arrows for tikz
#+latex_header: \usepackage{subcaption}                     % Subfigures
#+latex_header: \usepackage{animate}                        % Created animated things
#+latex_header: \usepackage{xcolor}

# ##############################################################################
# Slide Customization
# ##############################################################################


# ==============================================================================
#
#+latex_header: % Syntax: \colorboxed[<color model>]{<color specification>}{<math formula>}
#+latex_header: \newcommand*{\colorboxed}{}
#+latex_header: \def\colorboxed#1#{%
#+latex_header:   \colorboxedAux{#1}%
#+latex_header: }
#+latex_header: \newcommand*{\colorboxedAux}[3]{%
#+latex_header:   % #1: optional argument for color model
#+latex_header:   % #2: color specification
#+latex_header:   % #3: formula
#+latex_header:   \begingroup
#+latex_header:     \colorlet{cb@saved}{.}%
#+latex_header:     \color#1{#2}%
#+latex_header:     \boxed{%
#+latex_header:       \color{cb@saved}%
#+latex_header:       #3%
#+latex_header:     }%
#+latex_header:   \endgroup
#+latex_header: }

# ==============================================================================
#
#+latex_header:\renewcommand{\arraystretch}{1.5}

# ==============================================================================
# 16:9
#+LaTeX_CLASS_options: [aspectratio=169]

# ==============================================================================
# Control layout of individual slides
#+COLUMNS: %40ITEM %10BEAMER_env(Env) %9BEAMER_envargs(Env Args) %4BEAMER_col(Col) %10BEAMER_extra(Extra)

# ==============================================================================
# Add USU logo
#+latex_header:\logo{
#+latex_header:\begin{tikzpicture}[overlay,remember picture]
#+latex_header:\node[left=0.2cm] at (current page.26){
#+latex_header:\includegraphics[height=0.5cm]{img/u-state-black.png}
#+latex_header:};
#+latex_header:\end{tikzpicture}
#+latex_header:}

# ==============================================================================
# Add current section slides
#+BEAMER_HEADER: \AtBeginSection[]{

# This line inserts a table of contents with the current section highlighted at
# the beginning of each section
#+BEAMER_HEADER: \begin{frame}<beamer>\frametitle{Topic}\tableofcontents[currentsection]\end{frame}

# In order to have the miniframes/smoothbars navigation bullets even though we do not use subsections
# q.v. https://tex.stackexchange.com/questions/2072/beamer-navigation-circles-without-subsections/2078#2078
#+BEAMER_HEADER: \subsection{}
#+BEAMER_HEADER: }

# ==============================================================================
# Institute

#+latex_header: \institute[USU] % (optional)
#+latex_header: {
#+latex_header:   College of Engineering\\
#+latex_header:   Utah State University
#+latex_header: }

# ==============================================================================
# Slide numbers

#+latex_header: \beamertemplatenavigationsymbolsempty
#+latex_header: \addtobeamertemplate{navigation symbols}{}{%
#+latex_header:     \usebeamerfont{footline}%
#+latex_header:     \usebeamercolor[fg]{footline}%
#+latex_header:     \hspace{1em}%
#+latex_header:     \insertframenumber/\inserttotalframenumber
#+latex_header: }

# ##############################################################################
# Custom commands

#+latex_header: \newcommand\mycommfont[1]{\footnotesize\ttfamily\textcolor{gray}{#1}}

#+latex_header: \newcommand{\T}{\mathcal{T}}                % To make it clear the difference
#+latex_header: \newcommand{\Tau}{T}                        % between Tau and T
#+latex_header: \newcommand{\AC}{AC(u, d, v, \eta)}         % Set the parameters for AC once
#+latex_header: \newcommand{\UC}{UC(u, d, v)}               % Set the parameters for UC once
#+latex_header: \newcommand{\ACi}{AC(u_i, d_i, q_i, \eta_i)}% Set the parameters for AC once
#+latex_header: \newcommand{\UCi}{UC(u_i, d_i, q_i)}        % Set the parameters for UC once
#+latex_header: \newcommand{\Not}{\textbf{not }}            % Custom `not' operator
#+latex_header: \newcommand{\visit}{(i, b, a, e, u, d, q, \eta, \xi)}
#+latex_haeder:                                             % Single visit tuple
#+latex_header: \newcommand{\I}{\mathbb{I}}                 % Set of visit tuples
#+latex_header: \newcommand{\C}{\mathbb{C}}                 % Charger availability information
#+latex_header: \newcommand{\U}{\mathcal{U}}                % Uniform distribution
#+latex_header: \newcommand{\W}{\mathcal{W}}                % Weighted distribution
#+latex_header: \newcommand{\Sol}{\mathbb{S}}               % A shorthand for visit tuple
#+latex_header: \newcommand{\M}{\mathbb{M}}                 % A shorthand for the metadata
#+latex_header: \newcommand{\Hd}{\mathbb{H}}                % Set of discrete times
#+latex_header: \newcommand{\Nu}{\mathcal{V}}               % Draw a nice Nu

#+latex_header: \newcommand{\Iset}{I}                       % Set of visits 1-I
#+latex_header: \newcommand{\Isetinit}{I_0}                 % Set of visits inital visits
#+latex_header: \newcommand{\Isetfinal}{I_f}                % Set of visits final visits
#+latex_header: \newcommand{\Bset}{B}                       % Set of visits 1-B
#+latex_header: \newcommand{\Qset}{Q}                       % Set of visits 1-Q
#+latex_header: \newcommand{\Jset}{J}                       % Set of visits 1-J
#+latex_header: \newcommand{\Jsetq}{\mathbb{J}}             % Set of visits 1-J for queue active times
#+latex_header: \newcommand{\Hset}{H}                       % Set of visits 1-H

* Introduction
** Problem Description
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 0.8\textwidth
[[./img/route-schedule.pdf]]

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+begin_src latex
      \begin{figure}
      \centering
      \scalebox{0.4}{
        \centering
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge Queue 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            % Horizontal lines
            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src
** Overall Objective
** Model Objectives
** Brief State Of The Art

#+include: ./soa.org

** The Berth Allocation Problem[fn:3]
#+ATTR_LATEX: :width 0.8\textwidth
[[./img/berthing-sky-picture.png]]

** The Berth Allocation Problem
*** Left
:PROPERTIES:
:BEAMER_col: 0.4
:END:

- Vessels move down toward the quay
- Receive service
- Exit to the right
-----
- A variant of the rectangle packing problem
- Solves the problem of optimally assigning incoming vessels to be serviced

*** Right
:PROPERTIES:
:BEAMER_col: 0.6
:END:

#+ATTR_LATEX: :width 0.6\textwidth
[[./img/bap.pdf]]

#+ATTR_LATEX: :width 0.5\textwidth
[[./img/spatiotemporal-packing.pdf]]

** The Position Allocation Problem
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
src_latex{{\begin{center} {\small \underline{PAP Behavior}}}\end{center}}

#+latex:{\small
- Service flow is left to right
- Single charger type
- All arrivals are considered unique
- Service times are assumed to be known
#+latex:}

-----

src_latex{{\begin{center} {\small \underline{Desired Behavior}}}\end{center}}

#+latex:{\small
- Discrete charger queues
- Multiple charger types
- Bus can have multiple visits
- Propagate battery SOC across visits
- Unknown charge times
#+latex:}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 0.7\textwidth
[[./img/pap.pdf]]

#+begin_src latex
  \begin{figure}
    \centering
    \scalebox{0.3}{
      \centering
      \begin{tikzpicture}
        % Variables
        \def \arrx   {2.0}
        \def \initx  {3.5}
        \def \endx   {8.5}
        \def \depx   {10.0}
        \def \yshift {5}

        % Axis
        \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

        % Rectangles
        \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
        \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
        \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
        \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

      \end{tikzpicture}
    }
    \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src

* The Position Allocation Problem Approach With Linear Battery Dynamic
** Requirements For BEB Implementation
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- Charges must be able to be tracked
- Service time is unknown
- Accommodate different charger rates
- Minimize charger count
- Minimize consumption cost
- Encourage slow charger use for battery health

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width 0.8\textwidth
[[./img/pap.pdf]]

#+ATTR_LATEX: :width 0.7\textwidth
[[./img/visit.pdf]]

** Mixed Integer Linear Program
\begin{equation*}
\label{eq:objective}
	\colorboxed{red}{\min \sum_{i=1}^{n_V} \sum_{q=1}^{n_Q} \Big( w_{iq} m_q + g_{iq} \epsilon_q \Big)}
\end{equation*}

*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:BEAMER_env: beamercolorbox
:BEAMER_opt: shadow=true,rounded=true
:END:

#+latex:{\small
\begin{equation*}
\colorboxed{blue}{
\begin{array}{l}
    u_j - u_i - s_i - (\sigma_{ij} - 1)T \geq 0 \\
    v_j - v_i - (\psi_{ij} - 1)n_Q \geq 1 \\
    \sigma_{ij} + \sigma_{ji} \leq 1 \\
    \psi_{ij} + \psi_{ji} \leq 1 \\
    \sigma_{ij} + \sigma_{ji} + \psi_{ij} + \psi_{ji} \geq 1 \\
\end{array}}
\end{equation*}
\begin{equation*}
\colorboxed{orange}{
\begin{array}{l}
    \sum_{q=1}^{n_Q} w_{iq} = 1 \\
    v_i = \sum_{q=1}^{n_Q} qw_{iq} \\
\end{array}}
\end{equation*}
#+latex:}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex:{\small
\begin{equation*}
\colorboxed{purple}{
\begin{array}{l}
  s_i + u_i = d_i \\
  a_i \leq u_i \leq (T - s_i) \\
  d_i \leq \tau_i \\
\end{array}}
\end{equation*}
\begin{equation*}
\colorboxed{green}{
\begin{array}{l}
  \eta_i + \sum_{q=1}^{n_Q} g_{iq} r_q - \Delta_i = \eta_{\gamma_i} \\
  \eta_i + \sum_{q=1}^{n_Q} g_{iq} r_q - \Delta_i \geq \nu_{\Gamma_i} \kappa_{\Gamma_i} \\
  \eta_i + \sum_{q=1}^{n_Q} g_{iq} r_q \leq \kappa_{\Gamma_i} \\
  \eta_{\Gamma^0_b} = \alpha_{\Gamma_i} \kappa_{\Gamma_i} \\
  \eta_{\Gamma^f_b} \geq \beta_{\Gamma_b} \kappa_{\Gamma_b}    \\
\end{array}}
\end{equation*}
#+latex:}

** Queuing Constraints
*** Left
:PROPERTIES:
:BEAMER_col: 0.4
:END:

\begin{equation*}
\colorboxed{blue}{
\begin{array}{l}
    u_j - u_i - s_i - (\sigma_{ij} - 1)T \geq 0 \\
    v_j - v_i - (\psi_{ij} - 1)n_Q \geq 1 \\
    \sigma_{ij} + \sigma_{ji} \leq 1 \\
    \psi_{ij} + \psi_{ji} \leq 1 \\
    \sigma_{ij} + \sigma_{ji} + \psi_{ij} + \psi_{ji} \geq 1 \\
\end{array}}
\end{equation*}

-----

- Used to ensure that gray rectangles do not overlap
- $\sigma_{ij}$ establishes temporal ordering when active
- $\psi_{ij}$ establishes spacial ordering when active

*** Right
:PROPERTIES:
:BEAMER_col: 0.6
:END:
#+begin_src latex
      \begin{figure}
      \centering
      \scalebox{0.4}{
        \centering
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge Queue 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            % Horizontal lines
            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src
** Parameters
*** Left
:PROPERTIES:
:BEAMER_col: 0.3
:END:
#+ATTR_LATEX: :environment tabular :align l|l
|-----------+-------|
| Parameter | Value |
|-----------+-------|
| Execution |  2 hr |
| $T$       | 24 hr |
| $n_V$     |   338 |
| $n_A$     |    35 |
| $\alpha_i$     |   90% |
| $\nu_i$     |   25% |
| $\beta_i$     |   70% |
| $m_q$     | 1000q |
|-----------+-------|

*** Right
:PROPERTIES:
:BEAMER_col: 0.7
:END:

#+begin_src latex
      \begin{figure}
      \centering
      \scalebox{0.4}{
        \centering
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge Queue 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src

** Schedules
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/milp-pap/schedule-milp-pap}
\end{figure}

- Slow chargers utilized more frequently
- Fast chargers utilized sparingly

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/milp-pap/schedule-qin}
\end{figure}

- Slow chargers used for short durations
- Extensive use of fast chargers

** SOC And Energy Use
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :environment tabular :align l|cccc
|------+------------+-----------|
|      | MILP [kWh] | Qin [kWh] |
|------+------------+-----------|
| /    |          < |         < |
| Mean |    265.873 |    355.93 |
| Min  |      97.04 |     0.000 |
| Max  |        388 |   368.354 |
|------+------------+-----------|

- SOC of Qin allowed to drop to 0
- PAP maintained minimum SOC and final SOC

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+ATTR_LATEX: :width \textwidth
[[./img/milp-pap/energy-milp-pap.pdf]]

- PAP accumulated energy is larger due to minimum SOC constraints

* The Simulated Annealing Approach With Linear Battery Dynamics
** Objective Function And Constraints

\begin{equation*}
  \colorboxed{red}{J(\mathbb{I}) = z_d p_d + \sum_{i=1}^{n_V} \Big[ \epsilon_{q_i}r_{q_i} + z_p \phi_i(\eta_i - \nu_{b_i} \kappa_{b_i}) + z_c r_{q_i} s_i \Big]}
\end{equation*}

*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+latex:{\footnotesize
- $p_d$: Demand cost
  - $p_{T_p,h} = \frac{1}{T_p} \sum_{k = h-\frac{T_p}{dt}+1}^h p_k\; dt$
  - $p_{max} = \max\limits_{k \in [h-\frac{T_p}{dt}+1, h]}\; p_{T_p,h}$
  - $p_d = \max(p_{fix}, p_{max})$

  \begin{equation*}
    \colorboxed{purple}{
        \begin{array}{c}
          s_i = d_i - u_i \\
          a_i \leq u_i \leq d_i \le e_i \le \mathcal{T} \\
    \end{array}}
  \end{equation*}

  \begin{equation*}
    \colorboxed{green}{
        \begin{array}{c}
          \eta_{\xi_i} = \eta_{i} + r_{q_i}s_i - \Delta_i \\
          \kappa_{b_i} \geq \eta_{i} + r_{q_i}s_i \\
    \end{array}}
  \end{equation*}
#+latex:}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+latex:{\footnotesize
- $\epsilon_{q_i}r_{q_i}$: Assignment Cost
- $z_p \phi_i(\eta_i - \nu_{b_i} \kappa_{b_i})$: Penalty Function
- $z_c r_{q_i} s_i$: Consumption Cost

  \begin{equation*}
    \colorboxed{blue}{
    \begin{array}{l}
      u_j - d_i - (\sigma_{ij} - 1)T \ge 0 \\
      q_j - q_i - 1 - (\psi_{ij} - 1)Q \ge 0 \\
      \sigma_{ij} + \sigma_{ji} \le 1 \\
      \psi_{ij} + \psi_{ji} \le 1 \\
      \sigma_{ij} + \sigma_{ji} + \psi_{ij} + \psi_{ji} \ge 1
    \end{array}}
  \end{equation*}
#+latex:}

** Parameters

*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex:{\small
*NOTES*:
- Results are different from what is presented in the thesis
- BPAP model does not take demand cost into consideration
#+latex:}

#+ATTR_LATEX: :environment tabular :align l|c
| *Model*     | *Execution Time* [s] |
|-----------+--------------------|
| /         |                  < |
| BPAP      |               1900 |
| Quick     |               1533 |
| Heuristic |               1916 |
|-----------+--------------------|

**** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- $T_0 = 90000$
- $\beta = 0.997$

**** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- $|t| = 3797$
- $n_K = 500$

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+begin_src latex
      \begin{figure}
      \centering
      \scalebox{0.4}{
        \centering
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge Queue 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src

** Schedule
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex: {\scriptsize
- Qin heavily utilizes fast charger
- BPAP emphasizes slow queues, but utilizes fast chargers readily
#+latex: }

\begin{figure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-pap-paper-good/schedule-milp}
\end{subfigure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-pap-paper-good/schedule-qin}
\end{subfigure}
\end{figure}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex: {\scriptsize
- SA techniques heavily utilize slow charging
- SA techniques utilize fast chargers more sparingly
#+latex: }

\begin{figure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-pap-paper-good/schedule-sa-quick}
\end{subfigure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-pap-paper-good/schedule-sa-heuristic}
\end{subfigure}
\end{figure}

** Power
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-good/power-milp-qin}
\end{figure}

- Heuristic SA maintained the lowest demand peak

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-good/power-sa}
\end{figure}


- Quick SA peak demand comparable to the PAP peak

** SOC and Energy
*** Left
:PROPERTIES:
:BEAMER_col: 0.3
:END:

- SOC threshold deficits:
  - quick: 2.24 kWh
  - heuristic: 5.74 kWh
- Energy delta:
  - quick: 191.47 kWh
  - heuristic: 58.46 kWh
- Trade off of the lower peak demand

*** Right
:PROPERTIES:
:BEAMER_col: 0.7
:END:

\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-good/energy}
\end{figure}

** Scores and Energy
*** Left
:PROPERTIES:
:BEAMER_col: 0.35
:END:

#+ATTR_LATEX: :environment tabular :align l|c
|--------------+----------------|
| Schedule     | Score          |
|--------------+----------------|
| BPAP         | \num{18500000} |
| Qin-Modified | \num{34578526} |
| Heuristic    | \num{11673937} |
| Quick        | \num{11234577} |
|--------------+----------------|

*** Right
:PROPERTIES:
:BEAMER_col: 0.75
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=0.9\textwidth]{img/sa-pap-paper-good/energy-zoom}
\end{figure}

* Summary and Questions
** TODO Summary
** TODO Publications
** Questions?
:PROPERTIES:
:BEAMER_env: fullframe
:END:

\centering
\Huge Questions?

* Appendix
  :PROPERTIES:
  :BEAMER_env: appendix
  :END:

** Appendix
:PROPERTIES:
:BEAMER_env: fullframe
:END:

\centering
\Huge Appendix

** The Simulated Annealing Approach With Non-Linear Battery Dynamics
:PROPERTIES:
:BEAMER_env: fullframe
:END:

\centering
\Huge SA with Non-Linear Battery Dynamics

** Introduction
*** Left
:PROPERTIES:
:BEAMER_col: 0.3
:END:
- Higher fidelity in approximating charge at high SOC
- Implemented in SA for simplicity

*** Right
:PROPERTIES:
:BEAMER_col: 0.7
:END:

[[./img/nonlinear-bat.png]]

** Non-Linear Battery Dynamics Model
*** Left
:PROPERTIES:
:BEAMER_col: 0.3
:END:
#+begin_export latex
\begin{equation*}
\eta_{\xi_i} = \bar{a}_q \eta_i - \bar{b}_q \kappa_{b_i}
\end{equation*}
#+end_export

#+begin_export latex
\begin{equation*}
\begin{array}{cc}
  \bar{a}_q = e^{a_q dt} & \bar{b}_q = e^{a_q dt} - 1
\end{array}
\end{equation*}
#+end_export

*** Right
:PROPERTIES:
:BEAMER_col: 0.7
:END:

[[./img/nonlinear-bat-lin.png]]

** Results

*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex:{\scriptsize
- Minimized demand power
- Larger energy consumption due to fast charger duration
#+latex:}

\begin{figure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-nonlinear/power-sa-nonlinear}
\end{subfigure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-nonlinear/energy-sa-nonlinear}
\end{subfigure}
\end{figure}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+latex:{\scriptsize
- Similar schedule output, longer fast charger durations due to nonlinear model
- Minimum SOC of 85 kWh
#+latex:}

\begin{figure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-nonlinear/schedule-sa-nonlinear}
\end{subfigure}
\begin{subfigure}[t]{\textwidth}
\centering
    \includegraphics[width=0.7\textwidth]{img/sa-nonlinear/schedule-sa-heuristic}
\end{subfigure}
\end{figure}


** Mixed Integer Linear Programming

\begin{align*}
\text{max }        &J = \sum_j c_j x_j + \sum_k d_k y_k&         &               \\
\text{subject to } &\sum_j a_{ij} x_j + \sum_k g_{ik} y_k \le b_i&  &(i = 1,2,...,m)\\
                  &x_j \ge 0&                              &(j = 1,2,...,n)\\
                  &y_k \in \mathbb{Z^+}&                   &(k = 1,2,...,n)\\
\end{align*}

- $J$: Objective function
- $x_j \in \mathbb{R}$ and $y_k \in \mathbb{Z}^+$: Decision Variables
- $c_j, d_k, a_{ij}, g_{ik}, b_i \in \mathbb{R}$: Parameters


** Simulated Annealing
:PROPERTIES:
:BEAMER_env: fullframe
:END:

\centering
\Huge Simulated Annealing

** Simulated Annealing[fn:4]
*** Left                                                        :B_columns:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

- A probabilistic technique for approximating the global optimum of a given function.
- Often applied to problems that contain many local solutions
- Three key components:
  - Cooling Schedule
  - Acceptance Criteria
  - Generation Mechanisms

# +ATTR_LATEX: :width 0.6\linewidth
# [[./img/score-convergence.pdf]]

*** Right                                                       :B_columns:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

\centering
\animategraphics[width=0.9\linewidth]{10}{img/tsp/tsp-}{0}{87}

** Cooling Schedule
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- The cooling equation models the rate at which the temperature decreases over time in the SA process.
- The temperature is high, SA encourages exploration. As the temperature decreases, exploitation is encouraged.

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+begin_src latex
  \begin{figure}[t!]
    \centering \includegraphics[width=0.9\textwidth]{img/geometric.png}
    \label{fig:geometric}
  \end{figure}

  \begin{equation*}
  t_m = \beta t_{m-1}
  \end{equation*}
#+end_src

** Acceptance Criteria[fn:5]
#+name: eq:candaccept
\begin{equation*}
f(\mathbb{I},\bar{\mathbb{I}},t_m) =
\begin{cases}
  1                   & \Delta E > 0 \\
  e^{- \frac{\Delta E}{t_m}} & \text{otherwise}
\end{cases}
\end{equation*}

*** Left
:PROPERTIES:
:BEAMER_col: 0.7
:END:

\centering
\animategraphics[width=\linewidth]{10}{img/sa-visual/sa-}{90}{274}

*** Right
:PROPERTIES:
:BEAMER_col: 0.3
:END:

#+begin_src latex
  \begin{figure}[t!]
    \centering \includegraphics[width=\textwidth]{img/geometric.png}
    \label{fig:geometric}
  \end{figure}
#+end_src

** Generation Mechanisms - Primitive Functions
*** Left                                                        :B_columns:
:PROPERTIES:
:BEAMER_col: 0.4
:END:
- New Visit: Move a bus from a wait queue to charge queue
- Slide Visit: Change the charge duration of a visit
- New Charger: Move a visit to a new charger
- Wait: Move a visit to its idle queue
- New Window: Execute Wait then New Visit primitives

*** Right                                                   :B_columns:
:PROPERTIES:
:BEAMER_col: 0.6
:END:
#+begin_src latex
      \begin{figure}
      \centering
      \scalebox{0.4}{
        \centering
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge Idle 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            % Horizontal lines
            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src

** Generation Mechanisms - Wrapper Functions
*** Left                                                        :B_columns:
:PROPERTIES:
:BEAMER_col: 0.4
:END:
- Charge Schedule Generation: Iterate through each visit and execute New Visit
- Perturb Schedule: Randomly execute one of the primitives with a weighted distribution

*** Right                                                   :B_columns:
:PROPERTIES:
:BEAMER_col: 0.6
:END:
#+begin_src latex
      \begin{figure}
      \centering
        \centering
      \scalebox{0.4}{
          \begin{tikzpicture}
            % Variables
            \def \arrx   {2.0}
            \def \initx  {3.5}
            \def \endx   {8.5}
            \def \depx   {10.0}
            \def \yshift {5}

            % Axis
            \draw [thick,<->] (0,15) node[above]{\LARGE Queues} -- (0,0) -- (15,0) node[right]{\LARGE Time};

            % Rectangles
            \node[rectangle, draw, fill=gray, minimum width=4cm, minimum height = 3cm] at (3,12) {A};
            \node[rectangle, draw, fill=gray, minimum width=3cm, minimum height = 3cm] at (9,12) {B};
            \node[rectangle, draw, fill=gray, minimum width=5cm, minimum height = 3cm] at (6,7) {D};
            \node[rectangle, draw, fill=gray, minimum width=6cm, minimum height = 3cm] at (12,2) {C};

            % Y-axis labels
            \node[rotate=90] at (-1, 2.25) {\huge \textbf Idle 1};
            \node[rotate=90] at (-1, 7.25) {\huge Queue 2};
            \node[rotate=90] at (-1, 12.25) {\huge Queue 3};

            % Horizontal lines
            \draw[dotted] (0, 4.5) -- (15, 4.5);
            \draw[dotted] (0, 9.5) -- (15, 9.5);

          \end{tikzpicture}
        }
        \label{fig:spacial-and-temporal-constr}
  \end{figure}
#+end_src

** New Visit
#+include: alg/new-visit.org
** Slide Visit
#+include: alg/slide-visit.org
** New Charger
#+include: alg/new-charger.org
** Wait
#+include: alg/wait.org
** New Window
#+include: alg/new-window.org

** Charge Schedule Generation
#+include: alg/charge-schedule-generation.org

** Charge Schedule Perturbation
#+include: alg/tweak-schedule.org

** SA Thesis Results
:PROPERTIES:
:BEAMER_env: fullframe
:END:

\centering
\Huge Thesis Results

** Parameters
| *Model*     | *Execution Time* [s] | *Iteration* [s] |
|-----------+--------------------+---------------|
| MILP      |               3600 |           N/A |
| Quick     |            2275.25 |          0.25 |
| Heuristic |             3640.4 |           0.4 |

*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- $T_0 = 99999$
- $\beta = 0.999$
*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
- $|t| = 3797$
- $n_K = 500$

** Schedule
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/schedule-milp}
\end{figure}
*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/schedule-quinn}
\end{figure}

** Schedule
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/schedule-sa-quick}
\end{figure}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/schedule-sa-heuristic}
\end{figure}

** Power
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/power-milp-qin}
\end{figure}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/sa-pap-paper-bad/power-sa}
\end{figure}
** Energy
\begin{figure}[htpb]
\centering
    \includegraphics[width=0.6\textwidth]{img/sa-pap-paper-bad/energy}
\end{figure}

** How To Resolve This Problem?
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/score-convergence}
\end{figure}

- Reverse search and weight the visit indices
- Be more aggressive in exploiting the best solution

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:
\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/score-diverge}
\end{figure}

- Candidate solutions diverge
- Hard time handling "difficult" routes

** Score Convergence Comparison
*** Left
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+begin_center
Before Fix
#+end_center

\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/score-diverge}
\end{figure}

*** Right
:PROPERTIES:
:BEAMER_col: 0.5
:END:

#+begin_center
After Fix
#+end_center

\begin{figure}[htpb]
\centering
    \includegraphics[width=\textwidth]{img/score-convergence}
\end{figure}


** References
#+cite_export: bibtex plain
#+print_bibliography:

* Footnotes
[fn:5] https://en.wikipedia.org/wiki/Simulated_annealing
[fn:4] https://en.wikipedia.org/wiki/Simulated_annealing
[fn:3] https://www.mdpi.com/2077-1312/11/7/1280
[fn:2] PAP application only
[fn:1]  A visit describes when a bus arrives, assigned a charge queue, and then departs
